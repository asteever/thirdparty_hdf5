#! /bin/sh
#
# Copyright by the Board of Trustees of the University of Illinois.
# All rights reserved.
#
# This file is part of HDF5.  The full HDF5 copyright notice, including
# terms governing use, modification, and redistribution, is contained in
# the files COPYING and Copyright.html.  COPYING can be found at the root
# of the source code distribution tree; Copyright.html can be found at the
# root level of an installed copy of the electronic HDF5 document set and
# is linked from the top-level documents page.  It can also be found at
# http://hdf.ncsa.uiuc.edu/HDF5/doc/Copyright.html.  If you do not have
# access to either file, you may request a copy from hdfhelp@ncsa.uiuc.edu.
#
# Tests for the h5repack tool

H5REPACK=h5repack               # The tool name
H5REPACK_BIN=`pwd`/$H5REPACK    # The path of the tool binary

H5DIFF=../h5diff/h5diff         # The h5diff tool name
H5DIFF_BIN=`pwd`/$H5DIFF        # The path of the h5diff  tool binary

nerrors=0
verbose=yes

# The build (current) directory might be different than the source directory.
#
if test -z "$srcdir"; then
   srcdir=.
fi

test -d ../testfiles || mkdir ../testfiles

# Print a line-line message left justified in a field of 70 characters
# beginning with the word "Testing".
#
TESTING() {
   SPACES="                                                               "
   echo "Testing $* $SPACES" | cut -c1-70 | tr -d '\012'
}

# Print a line-line message left justified in a field of 70 characters
# beginning with the word "Verifying".
#
VERIFY() {
 SPACES="                                                               "
 echo "Testing h5diff output $* $SPACES" | cut -c1-70 | tr -d '\012'
}
      
# Call the h5diff tool
#
DIFFTEST() 
{
    VERIFY  $@
    if [ "`uname -s`" = "TFLOPS O/S" ]; then
	$RUNSERIAL $H5DIFF_BIN $@
    else
	$RUNSERIAL $H5DIFF_BIN "$@"
    fi
    RET=$?
    if [ $RET != 0 ] ; then
 	echo "*FAILED*"
         nerrors="`expr $nerrors + 1`"
    else
         echo " PASSED"
    fi
				    
}
										
# Call h5repack
#
TOOLTEST() 
{
    # Run test.
    # Tflops interprets "$@" as "" when no parameter is given (e.g., the
    # case of missing file name).  Changed it to use $@ till Tflops fixes it.
    TESTING $H5REPACK $@

    infile=$srcdir/../testfiles/$1
    outfile=out.$1
    shift
    if [ "`uname -s`" = "TFLOPS O/S" ]; then
	$RUNSERIAL $H5REPACK_BIN -i $infile -o $outfile $@
    else
	$RUNSERIAL $H5REPACK_BIN -i $infile -o $outfile "$@"
    fi

    RET=$?
    if [ $RET != 0 ] ; then
	echo "*FAILED*"
	nerrors="`expr $nerrors + 1`"
    else
	echo " PASSED"
	DIFFTEST $infile $outfile
    fi
    rm -f $outfile
}


#
# The tests
# We use the files generated by h5repacktst
# Each run generates "file4.out.h5" and the tool h5diff is used to
# compare the input and output files
#

# copy files
TOOLTEST test1.h5
TOOLTEST test3.h5
TOOLTEST test4.h5

#TOOLTEST test5.h5

# remove all  filters
TOOLTEST test4.h5 -f NONE

# remove one filter
TOOLTEST test4.h5 -f dset_gzip:NONE

# gzip
TOOLTEST test4.h5 -f dset1:GZIP=9
TOOLTEST test4.h5 -f GZIP=1

# szip
TOOLTEST test4.h5 -f dset1:SZIP=8
TOOLTEST test4.h5 -f SZIP=8

# shuffle
TOOLTEST test4.h5 -f dset1:SHUF
TOOLTEST test4.h5 -f SHUF

# fletcher
TOOLTEST test4.h5 -f dset1:FLET
TOOLTEST test4.h5 -f FLET

#layout chunk
TOOLTEST test4.h5 -l dset1:CHUNK=20x10
TOOLTEST test4.h5 -l CHUNK=20x10

#layout compact
TOOLTEST test4.h5 -l dset1:COMPA
TOOLTEST test4.h5 -l COMPA

#layout contiguous
TOOLTEST test4.h5 -l dset1:CONTI
TOOLTEST test4.h5 -l CONTI

#conversions
TOOLTEST test4.h5 -l dset_compact:CONTI
TOOLTEST test4.h5 -l dset_compact:CHUNK=2x5
TOOLTEST test4.h5 -l dset_compact:COMPA
TOOLTEST test4.h5 -l dset_contiguous:COMPA
TOOLTEST test4.h5 -l dset_contiguous:CHUNK=3x6
TOOLTEST test4.h5 -l dset_contiguous:CONTI
TOOLTEST test4.h5 -l dset_chunk:COMPA
TOOLTEST test4.h5 -l dset_chunk:CONTI
TOOLTEST test4.h5 -l dset_chunk:CHUNK=18x13

#filters
TOOLTEST test4.h5 -f dset1:SHUF -f dset1,dset2:GZIP=6
TOOLTEST test4.h5 -l dset1:CHUNK=20x10 -f dset1,dset2:SZIP=8

#filter conversions
TOOLTEST test4.h5 -f dset_gzip:SZIP=8
TOOLTEST test4.h5 -f dset_szip:GZIP=1
TOOLTEST test4.h5 -f dset_all:GZIP=1

#limit
TOOLTEST test4.h5 -f GZIP=1 -m 1024

#file
#TOOLTEST test4.h5 -e h5repack_info.txt

if test $nerrors -eq 0 ; then
   echo "All $H5REPACK tests passed."
fi

exit $nerrors
