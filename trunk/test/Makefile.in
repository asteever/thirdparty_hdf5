# HDF5 Library Test Makefile(.in)
#
# Copyright (C) 1997 National Center for Supercomputing Applications.
#                    All rights reserved.
#
# 
top_srcdir=@top_srcdir@
top_builddir=..
srcdir=@srcdir@
VPATH=.:@srcdir@
@COMMENCE@

# Add include directory to the C preprocessor flags and the h5test and hdf5
# libraries to the library list.
CPPFLAGS=-I. -I$(srcdir) -I../src -I$(top_srcdir)/src @CPPFLAGS@

# These are our main targets. They should be listed in the order to be
# executed, generally most specific tests to least specific tests.
RUNTEST=$(LT_RUN)
TEST_PROGS=testhdf5 lheap ohdr stab gheap hyperslab istore bittests dtypes   \
      dsets cmpd_dset extend external links unlink big mtime fillval mount   \
      flush1 flush2 enum
TIMINGS=iopipe chunk ragged overhead

# The libh5test.a library provides common support code for the tests. We link
# this library statically because some systems can only link executables to
# a single shared library and libhdf5 is much bigger than libh5test.
LT_LINK_LIB=$(LT) --mode=link $(CC) -static
LIBHDF5=../src/libhdf5.la
LIB=libh5test.a
LIB_SRC=h5test.c
LIB_OBJ=$(LIB_SRC:.c=.o)
PUB_LIB=

# Temporary files.  These files are the ones created by setting the
# HDF5_NOCLEANUP environment variable and running `make test' without
# specifying a file prefix or low-level driver.  Changing the file
# prefix or low-level driver with environment variables will influence 
# the temporary file name in ways that the makefile is not aware of.
MOSTLYCLEAN=cmpd_dset.h5 dataset.h5 extend.h5 istore.h5 tfile1.h5 tfile2.h5  \
	    tfile3.h5 th5s1.h5 lheap.h5 ohdr.h5 stab1.h5 stab2.h5            \
	    extern_1.h5 extern_2.h5 extern_3.h5 extern_1a.raw extern_1b.raw  \
	    extern_2a.raw extern_2b.raw extern_3a.raw extern_3b.raw          \
	    extern_4a.raw extern_4b.raw iopipe.raw iopipe.h5 gheap0.h5       \
	    gheap1.h5 gheap2.h5 gheap3.h5 gheap4.h5 links.h5 chunk.h5        \
	    big.data big[0-9][0-9][0-9][0-9][0-9].h5 dtypes1.h5 dtypes2.h5   \
            tattr.h5 tselect.h5 mtime.h5 ragged.h5 unlink.h5 overhead.h5     \
            fillval_[0-9].h5 fillval.raw mount_[0-9].h5 trefer.h5 flush.h5   \
	    enum1.h5
CLEAN=$(TIMINGS)

# Source and object files for programs...  The TEST_SRC list contains all the
# source files and is used for things like dependencies, archiving, etc.  The
# other source lists are for the individual tests, the files of which may
# overlap with other tests.
TEST_SRC=big.c bittests.c chunk.c cmpd_dset.c dsets.c dtypes.c extend.c      \
         external.c fillval.c flush1.c flush2.c gheap.c h5test.c hyperslab.c \
         iopipe.c istore.c lheap.c links.c mount.c mtime.c ohdr.c overhead.c \
	 ragged.c stab.c tattr.c testhdf5.c tfile.c th5s.c tmeta.c trefer.c  \
	 tselect.c unlink.c enum.c
TEST_OBJ=$(TEST_SRC:.c=.o)

# Private header files (not to be installed)...
PRIVATE_HDR=testhdf5.h

# Additional targets
.PHONY: timings _timings
timings _timings: $(TIMINGS)
	@for timing in $(TIMINGS) dummy; do				      \
	   if test $$timing != dummy; then				      \
	      echo "Running $$timing $(TEST_FLAGS)"; 			      \
	      $(RUNTEST) ./$$timing $(TEST_FLAGS) || exit 1; 		      \
	   fi;								      \
	done;

# How to build the tests...  They all depend on the test and hdf5 libraries.
$(TEST_PROGS): $(LIB) $(LIBHDF5)
TESTHDF5_OBJ=testhdf5.o tattr.o tfile.o tmeta.o trefer.o tselect.o th5s.o
testhdf5: $(TESTHDF5_OBJ)
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ $(TESTHDF5_OBJ) $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

lheap: lheap.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ lheap.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

ohdr: ohdr.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ ohdr.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

stab: stab.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ stab.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

gheap: gheap.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ gheap.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

dsets: dsets.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ dsets.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

bittests: bittests.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ bittests.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

dtypes: dtypes.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ dtypes.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

hyperslab: hyperslab.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ hyperslab.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

istore: istore.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ istore.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

cmpd_dset: cmpd_dset.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ cmpd_dset.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

extend: extend.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ extend.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

external: external.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ external.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

iopipe: iopipe.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ iopipe.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

big: big.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ big.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

links: links.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ links.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

chunk: chunk.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ chunk.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

mtime: mtime.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ mtime.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

ragged: ragged.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ ragged.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

unlink: unlink.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ unlink.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

overhead: overhead.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ overhead.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

fillval: fillval.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ fillval.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

mount: mount.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ mount.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

flush1: flush1.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ flush1.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

flush2: flush2.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ flush2.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

enum: enum.o
	@$(LT_LINK_EXE) $(CFLAGS) -o $@ enum.o $(LIB) $(LIBHDF5) $(LDFLAGS) $(LIBS)

@CONCLUDE@
